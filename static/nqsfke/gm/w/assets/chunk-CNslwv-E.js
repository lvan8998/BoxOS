import{C as e,r as n,e as t,w as a,f as l,b as o,z as s,M as u,A as r,n as i,D as d,E as c,P as v,F as m,Q as f}from"./chunk-DPRUGDB1.js";const p=new Map,h=new Map;function y(e,n,t,a,l,o,s){const u=-1*(s||-1);e.style.transform="translateX(0px)",e.style[u<0?"right":"left"]="".concat(t,"px");const r=performance.now(),i=t/a*1e3,d=t*u,c=-n*u;h.set(e,d);const v=requestAnimationFrame(function n(t){if(l())return;const a=t-r;if(a>=i)return void o(e);const s=d+a/i*(c-d);e.style.transform="translateX(".concat(s-d,"px)"),h.set(e,s);const u=requestAnimationFrame(n);p.set(e,u)});p.set(e,v)}function g(e,n,t,a,l,o,s){const u=h.get(e);if(void 0===u)return void y(e,n,t,a,l,o);const r=-1*(s||-1),i=t*r,d=-n*r,c=t/a*1e3,v=c*((i-u)/(i-d)),m=performance.now()-v,f=requestAnimationFrame(function n(t){if(l())return;const a=t-m;if(a>=c)return void o(e);const s=i+a/c*(d-i);e.style.transform="translateX(".concat(s-i,"px)"),h.set(e,s);const u=requestAnimationFrame(n);p.set(e,u)});p.set(e,f)}function x(e){const n=p.get(e);n&&(cancelAnimationFrame(n),p.delete(e))}function w(){p.forEach(e=>{cancelAnimationFrame(e)}),p.clear(),h.clear()}var E=e({name:"vue-danmaku",components:{},props:{danmus:{type:Array,required:!0,default:()=>[]},channels:{type:Number,default:0},autoplay:{type:Boolean,default:!0},loop:{type:Boolean,default:!1},loopOnly:{type:Boolean,default:!1},randomChannel:{type:Boolean,default:!1},isSuspend:{type:Boolean,default:!1},performanceMode:{type:Boolean,default:!0},debounce:{type:Number,default:100},speeds:{type:Number,default:200},top:{type:Number,default:4},right:{type:Number,default:0},zIndex:{type:Number,default:1},autoResize:{type:Boolean,default:!0},mirror:{type:Boolean,default:!1}},emits:["list-end","play-end","dm-over","dm-out","dm-click","dm-remove","error"],setup(e,{emit:d,slots:c,expose:v}){let m=n(document.createElement("div")),f=n(document.createElement("div"));const h=n(0),E=n(0),k=t(()=>e.mirror?1:-1),C=t(()=>e.mirror?"right":"left");let _=0;const b=n(0),L=n(0),A=n(0),M=n(!1),N=n(!0),B=n({}),I=n([...e.danmus]);a(()=>e.danmus,e=>{I.value=[...e]});const z=n(new Set);let R=null;!function(e,n,a="modelValue"){t({get:()=>e[a],set:e=>{n("update:".concat(a),e)}})}(e,d,"danmus");const S=l({channels:t(()=>e.channels||b.value),debounce:t(()=>e.debounce),randomChannel:t(()=>e.randomChannel)}),O=l({height:t(()=>L.value),speeds:t(()=>e.speeds),top:t(()=>e.top),right:t(()=>e.right)});function H(){h.value=m.value.offsetWidth,E.value=m.value.offsetHeight,(0===h.value||0===E.value)&&d("error",{message:"获取不到容器宽高",code:"CONTAINER_SIZE_ERROR"})}function W(){N.value&&(N.value=!1,_||(_=window.setInterval(()=>function(){if(!N.value&&I.value.length)if(A.value>I.value.length-1){const n=f.value.children.length;e.loop&&(n<A.value&&(d("list-end"),A.value=0,e.loopOnly&&z.value.clear()),X())}else X()}(),S.debounce)),e.performanceMode&&f.value&&Array.from(f.value.querySelectorAll(".dm")).forEach(e=>{g(e,e.offsetWidth,h.value,O.speeds,()=>N.value,T,k.value)}))}function X(n){const t=e.loop?A.value%I.value.length:A.value;if(e.loopOnly&&z.value.has(t))return;const a=function(e,n){const t=u({render:()=>r("div",{},[c.danmu&&c.danmu({danmu:e,index:n})])}),a=t.mount(document.createElement("div"));return a.$el.__vueApp=t,a}(n||I.value[t],t).$el;a.classList.add("dm"),f.value.appendChild(a),a.style.opacity="0",a._vueInstance={instance:a.__vueParentComponent||{ctx:{}},el:a},i(()=>{O.height||(L.value=a.offsetHeight),S.channels||(b.value=Math.floor(E.value/(O.height+O.top))),function(n,t){let a=function(e){let n=[...Array(S.channels).keys()];S.randomChannel&&(n=n.sort(()=>.5-Math.random()));for(let t of n){const n=B.value[t];if(!n||!n.length)return B.value[t]=[e],t%S.channels;for(let a=0;a<n.length;a++){const l=F(n[a])-10;if(l<=.88*(e.offsetWidth-n[a].offsetWidth)||l<=0)break;if(a===n.length-1)return B.value[t].push(e),t%S.channels}}return-1}(n);if(a>=0){const l=n.offsetWidth,o=O.height;n.dataset.index="".concat(t),n.dataset.channel=a.toString(),n.style.opacity="1",n.style.top=a*(o+O.top)+"px",n.style.width=l+O.right+"px",n.style.zIndex=e.zIndex.toString();const s=e=>{d("dm-click",{el:n,index:t,danmu:I.value[t],event:e})};if(n.addEventListener("click",s),n._clickHandler=s,e.loop&&e.loopOnly&&z.value.add(t),e.performanceMode)y(n,l,h.value,O.speeds,()=>N.value,T,k.value);else{n.classList.add("move"),n.style.setProperty("--dm-scroll-width",(h.value+l)*k.value+"px"),n.style[C.value]="".concat(h.value,"px"),n.style.animationDuration=h.value/O.speeds+"s";const t=()=>{Number(n.dataset.index)!==I.value.length-1||e.loop||d("play-end",n.dataset.index);const t=Number(n.dataset.index);e.loop&&e.loopOnly&&t>=0&&z.value.delete(t),d("dm-remove",{el:n,index:t,danmu:t>=0?I.value[t]:null}),V(n),f.value&&n.parentNode===f.value&&f.value.removeChild(n)};n._animationEndHandler=t,n.addEventListener("animationend",t)}A.value++}else V(n),f.value&&n.parentNode===f.value&&f.value.removeChild(n)}(a,t)})}function F(n){return e.mirror?function(e){const n=e.offsetWidth||parseInt(e.style.width),t=e.getBoundingClientRect().left||f.value.getBoundingClientRect().left+n;return f.value.getBoundingClientRect().left+t}(n):function(e){const n=e.offsetWidth||parseInt(e.style.width),t=e.getBoundingClientRect().right||f.value.getBoundingClientRect().right+n;return f.value.getBoundingClientRect().right-t}(n)}function q(){clearInterval(_),_=0,A.value=0,z.value.clear()}function D(){q(),f.value&&(Array.from(f.value.querySelectorAll(".dm")).forEach(e=>{V(e)}),f.value.innerHTML=""),e.performanceMode&&w(),B.value={},N.value=!0}function T(n){Number(n.dataset.index)!==I.value.length-1||e.loop||d("play-end",n.dataset.index);const t=Number(n.dataset.index);e.loop&&e.loopOnly&&t>=0&&z.value.delete(t),d("dm-remove",{el:n,index:A,danmu:t>=0?I.value[t]:null}),V(n),f.value&&n.parentNode===f.value&&f.value.removeChild(n)}function P(){const n=h.value;H();const t=f.value.getElementsByClassName("dm");for(let a=0;a<t.length;a++){const l=t[a],o=l.offsetWidth;if(e.performanceMode){let e=(n-(l.getBoundingClientRect().left-m.value.getBoundingClientRect().left))/(n+o);if(e=Math.max(0,Math.min(1,e)),x(l),e>=1)T(l);else{const n=h.value-(h.value+o)*e;l.style[C.value]="".concat(h.value,"px"),l.style.transform="translateX(".concat(n-h.value,"px)"),g(l,o,h.value,O.speeds,()=>N.value,T,k.value)}}else l.style.setProperty("--dm-scroll-width",(h.value+o)*k.value+"px"),l.style[C.value]="".concat(h.value,"px"),l.style.animationDuration=h.value/O.speeds+"s"}}o(()=>{H(),e.isSuspend&&(f.value.addEventListener("mouseover",j),f.value.addEventListener("mouseout",Q)),c.danmu||d("error",{message:'没有提供弹幕插槽内容(slot="danmu")，无法展示弹幕',code:"NO_DANMU_SLOT"}),e.autoplay&&W(),e.autoResize&&function(){if("undefined"!=typeof ResizeObserver)R=new ResizeObserver(()=>{P()}),R.observe(m.value);else{const e=()=>P();window.addEventListener("resize",e),s(()=>{window.removeEventListener("resize",e)})}}()}),s(()=>{D(),f.value&&(f.value.removeEventListener("mouseover",j),f.value.removeEventListener("mouseout",Q)),R&&(R.disconnect(),R=null),e.performanceMode&&w()});let $=[];function j(n){let t=n.target;t.classList.contains("dm")||(t=t.closest(".dm")||t),t.classList.contains("dm")&&($.includes(t)||(d("dm-over",{el:t}),t.style.zIndex=(e.zIndex+1).toString(),e.performanceMode?x(t):t.classList.add("pause"),$.push(t)))}function Q(e){let n=e.target;n.classList.contains("dm")||(n=n.closest(".dm")||n),n.classList.contains("dm")&&(d("dm-out",{el:n}),U(n),$.forEach(U),$=[])}function U(n){n.style.zIndex=e.zIndex.toString(),e.performanceMode?g(n,n.offsetWidth,h.value,O.speeds,()=>N.value,T,k.value):n.classList.remove("pause")}function V(n){e.performanceMode?x(n):n._animationEndHandler&&(n.removeEventListener("animationend",n._animationEndHandler),delete n._animationEndHandler),n._clickHandler&&(n.removeEventListener("click",n._clickHandler),delete n._clickHandler);const t=n.dataset.channel?parseInt(n.dataset.channel):-1;if(t>=0&&B.value[t]){const e=B.value[t].indexOf(n);e>-1&&B.value[t].splice(e,1)}if(n.__vueApp){try{n.__vueApp.unmount()}catch(a){}delete n.__vueApp}n._vueInstance&&delete n._vueInstance}return{container:m,dmContainer:f,hidden:M,paused:N,danmuList:I,getPlayState:function(){return!N.value},getMaxChannels:function(){return O.height?Math.floor(E.value/(O.height+O.top)):0},resize:P,play:W,pause:function(){N.value=!0,e.performanceMode&&(p.forEach(e=>{cancelAnimationFrame(e)}),p.clear())},stop:D,show:function(){M.value=!1},hide:function(){M.value=!0},clear:q,reset:function(){D(),L.value=0,M.value=!1,H()},addDanmu:function(e,n="current"){if("current"===n){if(A.value===I.value.length)return I.value.push(e),I.value.length-1;{const n=A.value%I.value.length;return I.value.splice(n,0,e),n+1}}return I.value.push(e),I.value.length-1},insert:X}}});const k={ref:"container",class:"vue-danmaku"};!function(e,n){void 0===n&&(n={});var t=n.insertAt;if("undefined"!=typeof document){var a=document.head||document.getElementsByTagName("head")[0],l=document.createElement("style");l.type="text/css","top"===t&&a.firstChild?a.insertBefore(l,a.firstChild):a.appendChild(l),l.styleSheet?l.styleSheet.cssText=e:l.appendChild(document.createTextNode(e))}}(".vue-danmaku {\n  position: relative;\n  overflow: hidden;\n  height: 100%;\n  width: 100%;\n}\n.vue-danmaku .danmus {\n  position: absolute;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  opacity: 0;\n  -webkit-transition: all 0.3s;\n  transition: all 0.3s;\n}\n.vue-danmaku .danmus.show {\n  opacity: 1;\n}\n.vue-danmaku .danmus.paused .dm.move {\n  animation-play-state: paused;\n}\n.vue-danmaku .danmus .dm {\n  position: absolute;\n  font-size: 20px;\n  color: #666;\n  white-space: pre;\n  cursor: default;\n  transform: translateX(0);\n  transform-style: preserve-3d;\n}\n.vue-danmaku .danmus .dm.move {\n  will-change: transform;\n  animation-name: moveLeft;\n  animation-timing-function: linear;\n  animation-play-state: running;\n}\n.vue-danmaku .danmus .dm.pause {\n  animation-play-state: paused;\n}\n@keyframes moveLeft {\n  from {\n    transform: translateX(0);\n  }\n  to {\n    transform: translateX(var(--dm-scroll-width));\n  }\n}\n@-webkit-keyframes moveLeft {\n  from {\n    -webkit-transform: translateX(0);\n  }\n  to {\n    -webkit-transform: translateX(var(--dm-scroll-width));\n  }\n}"),E.render=function(e,n,t,a,l,o){return c(),d("div",k,[v("div",{ref:"dmContainer",class:f(["danmus",{show:!e.hidden},{paused:e.paused}])},null,2),m(e.$slots,"default")],512)},E.__file="src/lib/Danmaku.vue";export{E as k};
